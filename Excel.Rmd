---
title: "R und Excel"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```


Immer wieder kommt es vor, dass Daten für andere Nutzer in Excel exportiert werden müssen. Mit dem Package openxlsx lassen sich die Daten nicht nur abspeichern, sie können auch beliebig formatiert werden. Somit eignet sich das Package perfekt zur automatisierten Erstellung von Exceldateien. Wer viele Excelsheets generieren möchte, kann das z.B. auch mit Hilfe von Schleifen umsetzen.

Auch das Auslesen von Exceldateien ist mit openxlsx sehr komfortabel möglich. Hierbei können sowohl ganze Excelsheets als auch Teile daraus aufgerufen werden.

# Workbook anlegen

Als erstes muss immer ein leeres Workbook angelegt werden.

```{r}
library(openxlsx)

# Workbook erstellen
wb <- createWorkbook()
```

# Workbook befüllen

In diesem Workbook werden nun die Sheets erstellt. Hier verwende ich den Iris-Datensatz. Die Formatierung kann mit dem Befehl createStyle() vorgenommen werden.
Hierbei lassen sich verschiedene Styles definieren und auf die gespeicherten Daten bzw. auch beliebige Zellen im Excelsheet anwenden.

## Worksheet erstellen
```{r}
# Excelsheet anlegen und benennen
addWorksheet(wb, "Daten")
```

## Styles definieren un Daten schreiben

```{r}
#Styles definieren
header_style <- createStyle(halign = "center", textDecoration = "bold", border = "Bottom")
style_grau <- createStyle(fgFill = "#d6d6d6", fontColour = "#313c48")

# Daten in Sheet schreiben, headerStyle kann mit definiert werden
writeData(wb, "Daten", iris, headerStyle = header_style)

# Formatierung bestimmter Zellen:
addStyle(wb, "Daten", rows = 2:(nrow(iris)+1), cols = 2, style = style_grau)

```

# Weitere Formatierungen

## Spaltenbreite

Die Spaltenbreite kann automatisch angepasst oder anhand eines Vektors individuell festgelegt werden.

```{r}

# Spaltenbreite automatisch anpassen
setColWidths(wb, sheet = "Daten", cols = 1:ncol(iris), widths = "auto")
# Spaltenbreite individuel verändern
setColWidths(wb, sheet = "Daten", cols = 1:ncol(iris),  widths = c(16, 15, 12, 33))

# Zeilenhöhe anpassen
setRowHeights(wb, sheet = "Daten", rows = 1:nrow(iris),  heights = rep(30,times=nrow(iris)))
```

## Bedingte Formatierung

```{r}
#Daten mit Wert größer gleich 3 rot einfärben
style_rot <- createStyle(fontColour = "#ff5232")

conditionalFormatting(wb, "Daten",
  cols = 1:3, rows = 2:nrow(iris), rule = "A2>=3", style = style_rot
)
```

# Datenüberprüfung 

Wir können festlegen welche Werte in eine Spalte eingegeben werden dürfen. Entspricht die Eingabe nicht der Vorgabe, entsteht eine Fehlermeldung in Excel.

```{r}
# Neues Sheet
addWorksheet(wb, "Datenüberprüfung")

#Überprüfung auf Wert
writeData(wb, "Datenüberprüfung", x = "Zahl zwischen 1 und 5 eingeben", startCol = 1, startRow = 2)
dataValidation(wb, "Datenüberprüfung",
  cols = 2, rows = 2, type = "whole",
  operator = "between", value = c(1,5)
) 
#Überprüfung auf Datum
writeData(wb, "Datenüberprüfung", x = "Datum eingeben", startCol = 1, startRow = 4)
dataValidation(wb, "Datenüberprüfung",
  cols = 2, rows = 4, type = "date",
  operator = "greaterThanOrEqual", value = as.Date("2022-01-01")
)  

#Um Auswahlfelder zu generieren  kann ebenfalls die Funktion dataValidation() verwendet werden.
addWorksheet(wb, "Dropdown")
writeData(wb, "Dropdown", x = c("A","B","C"), startCol = 1, startRow = 1)

writeData(wb, "Datenüberprüfung", x = "Wert auswählen", startCol = 1, startRow = 6)
dataValidation(wb, "Datenüberprüfung", col = 2, rows = 6, type = "list", value = "'Dropdown'!$A$1:$A$3")

# Feld das überprüft wird grau hervorheben
addStyle(wb, "Datenüberprüfung", cols = c(2,2,2), rows = c(2,4,6), style = style_grau)

setColWidths(wb, sheet = "Datenüberprüfung", cols = 1:2, widths = c(30,12))

```

# Sonstiges

## Zeilen / Spalten fixieren

```{r}
freezePane(wb, "Daten", firstActiveRow = 2, firstActiveCol = 1)
```

## Blattschutz

Um Zellen vom Blattschutz auszunehmen, kann bei der Erstellung des Styles locked = FALSE gesetzt werden. 

```{r}
# Style definieren
style_grau_ungeschuetzt <- createStyle(fgFill = "#d6d6d6", fontColour = "#313c48", locked = FALSE)
# Style auf veränderbare Zellen anwenden
addStyle(wb, "Datenüberprüfung", cols = c(2,2,2), rows = c(2,4,6), style = style_grau_ungeschuetzt)
# Blatt schützen
protectWorksheet(wb, "Datenüberprüfung", protect = TRUE)
```

# Workbook speichern

Nachdem alles definiert und formatiert wurde, kann das Workbook als Exceldatei abgespeichert werden.

```{r}
# Workbook speichern:
saveWorkbook(wb, "Test_Daten.xlsx", overwrite = T)
```

